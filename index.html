
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ ¸ CORE - æ¸©æš–å®ˆæŠ¤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥åœ†æ¶¦å¯çˆ±çš„å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* æ²»æ„ˆç³»å¥¶æ²¹æš–è‰²è°ƒ */
            --bg-color: #fff9f5; /* ææ·¡çš„ç²‰è‚¤è‰²èƒŒæ™¯ */
            --card-bg: rgba(255, 255, 255, 0.92);
            --primary: #ffb7b2; /* æŸ”å’Œçš„çŠç‘šç²‰ */
            --primary-dark: #ff9e99;
            --accent: #e2f0cb; /* é¼ å°¾è‰ç»¿ */
            --text-main: #6d5c58; /* æš–æ£•è‰²æ–‡å­—ï¼Œæ¯”é»‘è‰²æ›´æ¸©æŸ” */
            --text-sub: #9e8e8a;
            --shadow-soft: 0 10px 40px -10px rgba(255, 183, 178, 0.3);
            --shadow-inset: inset 2px 2px 5px rgba(209, 194, 194, 0.1);
            --radius-bubble: 25px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Nunito', 'PingFang SC', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* èƒŒæ™¯ï¼šæµåŠ¨çš„è‰ºæœ¯å…‰æ–‘ */
        .ambient-light {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
            background: #fff9f5;
        }
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.6;
            animation: float 20s infinite alternate;
        }
        .blob-1 { width: 400px; height: 400px; background: #ffdac1; top: -10%; left: -10%; animation-delay: 0s; }
        .blob-2 { width: 300px; height: 300px; background: #e2f0cb; bottom: 10%; right: -5%; animation-delay: -5s; }
        .blob-3 { width: 250px; height: 250px; background: #b5ead7; top: 40%; left: 30%; animation-delay: -10s; opacity: 0.4; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        /* å¯¼èˆªæ ï¼šæ‚¬æµ®èƒ¶å›Š */
        nav {
            position: fixed;
            bottom: 30px; /* ç§»åŠ¨åˆ°åº•éƒ¨ï¼Œåƒæ‰‹æœºAPPä¸€æ ·ï¼Œæ›´æ–¹ä¾¿å•æ‰‹æ“ä½œ */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            padding: 15px 30px;
            border-radius: 50px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(109, 92, 88, 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-sub);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        
        .nav-item.active { color: var(--primary-dark); transform: translateY(-5px); }
        .nav-item.active i { transform: scale(1.2); }

        /* é¡¶éƒ¨Logo */
        header {
            padding: 30px 20px 10px;
            text-align: center;
        }
        .logo {
            font-family: 'ZCOOL KuaiLe', cursive; /* å¯çˆ±çš„è‰ºæœ¯å­—ä½“ */
            font-size: 2.2rem;
            color: var(--text-main);
            letter-spacing: 4px;
        }
        .logo span { color: var(--primary); }
        .subtitle { font-size: 0.9rem; color: var(--text-sub); margin-top: 5px; opacity: 0.8; }

        /* ä¸»å®¹å™¨ */
        main {
            padding: 20px 20px 120px; /* åº•éƒ¨ç•™ç™½ç»™å¯¼èˆª */
            max-width: 800px;
            margin: 0 auto;
        }

        section { display: none; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        section.active { display: block; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* å¡ç‰‡é€šç”¨æ ·å¼ï¼šåƒçº¸å¼ ä¸€æ · */
        .card {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 30px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
        }

        /* æŒ‰é’®ï¼šåƒç³–æœä¸€æ · */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 183, 178, 0.5);
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }
        .btn:active { transform: scale(0.95); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); box-shadow: none; }
        
        /* 0. æµ‹è¯„ç³»ç»Ÿ */
        .question-progress {
            height: 10px; background: #eee; border-radius: 10px; overflow: hidden; margin-bottom: 30px;
        }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 100%); width: 0%; transition: width 0.5s ease; }
        
        .option-grid { display: grid; gap: 12px; }
        .quiz-option {
            background: #fff;
            border: 2px solid transparent;
            padding: 18px;
            border-radius: 20px;
            color: var(--text-main);
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .quiz-option:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.05); }
        .quiz-option:active { transform: scale(0.98); }
        .quiz-option.selected { border-color: var(--primary); background: #fff5f5; color: var(--primary-dark); }
        .circle-check { width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%; margin-right: 15px; }
        .quiz-option.selected .circle-check { background: var(--primary); border-color: var(--primary); }

        /* å±æœºæ¨ªå¹…ï¼šæ¸©æŸ”çš„æé†’ */
        .crisis-card {
            background: linear-gradient(135deg, #fff0f0 0%, #ffe9e9 100%);
            border-left: 6px solid #ff8a80;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            color: #c65f5a;
        }
        .crisis-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .hotline-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .hotline-tag { background: rgba(255,255,255,0.6); padding: 5px 12px; border-radius: 12px; font-size: 0.85rem; }

        /* 1. å‘¼å¸æ­£å¿µï¼šå…‰æ™•æ•ˆæœ */
        .breathe-scene {
            height: 50vh; display: flex; justify-content: center; align-items: center; position: relative;
        }
        .sun-glow {
            width: 150px; height: 150px;
            background: radial-gradient(circle, #ffecd2 0%, #fcb69f 100%);
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 40px rgba(252, 182, 159, 0.6);
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 1.2rem; font-weight: bold;
            text-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .sun-orbit {
            position: absolute; width: 250px; height: 250px; border: 1px dashed rgba(252, 182, 159, 0.5); border-radius: 50%;
            animation: rotate 60s linear infinite;
        }
        .breathe-anim-active { animation: deepBreathe 8s infinite ease-in-out; }
        @keyframes deepBreathe {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(252, 182, 159, 0.4); }
            40% { transform: scale(1.6); box-shadow: 0 0 80px rgba(252, 182, 159, 0.8); background: radial-gradient(circle, #a1c4fd 0%, #c2e9fb 100%); } /* å¸æ°”å˜è“è°ƒ */
            50% { transform: scale(1.6); }
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }

        /* 2. æƒ…æ„Ÿè®°å½• */
        .mood-selector { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .mood-icon {
            font-size: 2rem; cursor: pointer; transition: transform 0.2s; opacity: 0.6;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .mood-icon span { font-size: 0.7rem; font-weight: bold; }
        .mood-icon:hover, .mood-icon.active { opacity: 1; transform: scale(1.2); }
        .mood-icon.active { filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
        
        .timeline { padding-left: 20px; border-left: 2px dashed #eee; margin-top: 30px; }
        .timeline-item { position: relative; margin-bottom: 25px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .timeline-dot { position: absolute; left: -26px; top: 15px; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; border: 3px solid #fff9f5; }

        /* 3. AI èŠå¤©ï¼šæ°”æ³¡é£ */
        .chat-container {
            height: 65vh; display: flex; flex-direction: column;
        }
        .chat-box { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 15px; }
        .msg-bubble {
            max-width: 85%; padding: 15px 20px; border-radius: 20px; font-size: 0.95rem; line-height: 1.6; position: relative;
            animation: floatUp 0.3s ease;
        }
        @keyframes floatUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-ai { background: #fff; color: var(--text-main); border-bottom-left-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .msg-user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 5px; box-shadow: 0 4px 10px rgba(255, 183, 178, 0.4); }
        
        .chat-input-wrapper {
            background: white; padding: 10px; border-radius: 50px; display: flex; align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-top: 15px; border: 1px solid #eee;
        }
        .chat-input { flex: 1; border: none; outline: none; padding: 10px 15px; font-size: 1rem; color: var(--text-main); background: transparent; }
        .send-btn-round { width: 40px; height: 40px; background: var(--text-main); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; }
        .send-btn-round:hover { transform: scale(1.1); }

        /* ç‰ˆæƒ */
        .footer-info { text-align: center; color: var(--text-sub); font-size: 0.75rem; margin-top: 40px; opacity: 0.7; }
        
        /* å›¾è¡¨æ ·å¼é‡ç½® */
        canvas { background: #fff; border-radius: 15px; padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <!-- æ°›å›´èƒŒæ™¯ -->
    <div class="ambient-light">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <header>
        <div class="logo">æ ¸ <span>CORE</span></div>
        <div class="subtitle">æŸ”è½¯åœ°æ¥ä½ä½ çš„æ¯ä¸€ä¸ªæƒ…ç»ª</div>
        <div id="daily-quote" style="margin-top: 15px; font-style: italic; color: #a6908c; font-size: 0.9rem;">
            "ä»Šå¤©ä¹Ÿè¯·æ¸©æŸ”åœ°çˆ±è‡ªå·±ã€‚"
        </div>
    </header>

    <main>
        <!-- 0. æµ‹è¯„ç³»ç»Ÿ -->
        <section id="home" class="active">
            <div id="quiz-intro" class="card" style="text-align: center; padding: 50px 30px;">
                <div style="font-size: 4rem; margin-bottom: 20px;">ğŸŒ¿</div>
                <h2 style="margin-bottom: 15px; color: var(--text-main);">å‡†å¤‡å¥½æ¢ç´¢å†…å¿ƒäº†å—ï¼Ÿ</h2>
                <p style="color: var(--text-sub); line-height: 1.8; margin-bottom: 30px;">
                    è¿™é‡Œæ²¡æœ‰è¯„åˆ¤ï¼Œåªæœ‰å€¾å¬ã€‚<br>60é“å…³äºå½“ä¸‹çš„é—®é¢˜ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£ä½ ã€‚<br>
                    <span style="color: var(--primary); font-size: 0.9em;">( åŸºäºSCL-90åŠå›½é™…ç„¦è™‘æŠ‘éƒé‡è¡¨ )</span>
                </p>
                <button onclick="startQuiz()" class="btn">å¼€å§‹å¿ƒçµæ—…ç¨‹</button>
            </div>

            <div id="quiz-interface" class="card" style="display: none;">
                <div class="question-progress"><div class="progress-bar" id="progress"></div></div>
                
                <h3 id="question-text" style="font-size: 1.3rem; margin-bottom: 30px; line-height: 1.5; min-height: 3em;">é¢˜ç›®åŠ è½½ä¸­...</h3>
                
                <div class="option-grid" id="options-container">
                    <!-- é€‰é¡¹å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                </div>
            </div>

            <div id="quiz-result" style="display: none;">
                <!-- å±æœºæ¨ªå¹… -->
                <div class="crisis-card" id="crisis-banner" style="display: none;">
                    <div class="crisis-title"><i class="fas fa-heart-broken"></i> æˆ‘ä»¬éƒ½åœ¨ä½ èº«è¾¹</div>
                    <p style="font-size: 0.95rem; line-height: 1.6;">æ£€æµ‹åˆ°æ‚¨çš„æƒ…ç»ªç›®å‰å¯èƒ½å¤„äºæš´é£é›¨ä¸­ã€‚è¯·è®°ä½ï¼Œè¿™å¹¶ä¸æ˜¯æ‚¨çš„é”™ï¼Œä¹Ÿä¸å¿…ç‹¬è‡ªé¢å¯¹ã€‚ä¸“ä¸šçš„å®ˆæŠ¤è€…ä»¬24å°æ—¶å¾…å‘½ã€‚</p>
                    <div style="margin-top: 15px; font-weight: bold;">åŒ—äº¬24å°æ—¶å…è´¹å¿ƒç†å±æœºå’¨è¯¢çƒ­çº¿ï¼š010-82951332</div>
                    <div class="hotline-tags">
                        <div class="hotline-tag">å…¨å›½: 010-82951332</div>
                        <div class="hotline-tag">ä¸Šæµ·: 021-12320-5</div>
                        <div class="hotline-tag">å¹¿ä¸œ: 020-81899120</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="text-align: center; margin-bottom: 15px;">å¿ƒçµé›·è¾¾</h3>
                    <canvas id="radarChart"></canvas>
                </div>
                
                <div class="card">
                    <h3>åˆ†æå¯„è¯­</h3>
                    <div id="analysis-text" style="margin-top: 15px; line-height: 1.8; color: var(--text-main);"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                        <button onclick="consultAIWithResult()" class="btn">å’¨è¯¢ AI åŠ©æ‰‹</button>
                        <button onclick="resetQuiz()" class="btn btn-outline">é‡æ–°æµ‹è¯„</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 1. å‘¼å¸æ­£å¿µ -->
        <section id="breathe">
            <div class="card" style="text-align: center; background: rgba(255,255,255,0.8);">
                <h3 style="margin-bottom: 10px;">æ·±å‘¼å¸ç»ƒä¹ </h3>
                <p style="color: var(--text-sub); margin-bottom: 20px;">è·Ÿéšå…‰èŠ’çš„èŠ‚å¥ï¼Œæ‰¾å›å†…å¿ƒçš„å¹³é™</p>
                
                <div class="breathe-scene">
                    <div class="sun-orbit"></div>
                    <div class="sun-glow" id="breathe-circle">å¸æ°”</div>
                </div>

                <button onclick="toggleBreathe()" class="btn" id="breathe-btn" style="margin-top: 20px;">å¼€å§‹ç»ƒä¹ </button>
            </div>
        </section>

        <!-- 2. æƒ…æ„Ÿè®°å½• -->
        <section id="mood">
            <div class="card">
                <h3>ä»Šæ—¥å¿ƒæƒ…</h3>
                <p style="color: var(--text-sub); margin-bottom: 20px; font-size: 0.9rem;">è®°å½•ä¸‹æ¯ä¸€ä¸ªçœŸå®çš„å½“ä¸‹</p>

                <div class="mood-selector">
                    <div class="mood-icon" onclick="selectMood('happy')" id="m-happy">
                        <div>ğŸ˜„</div><span>å¼€å¿ƒ</span>
                    </div>
                    <div class="mood-icon" onclick="selectMood('calm')" id="m-calm">
                        <div>ğŸ˜Œ</div><span>å¹³é™</span>
                    </div>
                    <div class="mood-icon" onclick="selectMood('anxious')" id="m-anxious">
                        <div>ğŸ˜Ÿ</div><span>ç„¦è™‘</span>
                    </div>
                    <div class="mood-icon" onclick="selectMood('sad')" id="m-sad">
                        <div>ğŸŒ§ï¸</div><span>ä½è½</span>
                    </div>
                    <div class="mood-icon" onclick="selectMood('angry')" id="m-angry">
                        <div>ğŸ˜¡</div><span>ç”Ÿæ°”</span>
                    </div>
                </div>
                <input type="hidden" id="selected-mood-val">

                <div class="chat-input-wrapper" style="margin-bottom: 20px;">
                    <input type="text" id="mood-reason" class="chat-input" placeholder="å†™ä¸‹æ­¤åˆ»çš„æƒ³æ³•ï¼ˆå¯é€‰ï¼‰...">
                    <div class="send-btn-round" onclick="addMoodLog()"><i class="fas fa-check"></i></div>
                </div>

                <canvas id="moodChart" height="200"></canvas>

                <div class="timeline" id="mood-history">
                    <!-- å†å²è®°å½• -->
                </div>
            </div>
        </section>

        <!-- 3. AI å’¨è¯¢ -->
        <section id="ai">
            <div class="card" style="padding: 0; background: transparent; box-shadow: none; border: none;">
                <div class="chat-container">
                    <div class="chat-box" id="chat-window">
                        <div class="msg-bubble msg-ai">
                            ä½ å¥½å‘€ï¼Œæˆ‘æ˜¯â€œæ ¸â€ã€‚<br>ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿæ— è®ºå¼€å¿ƒè¿˜æ˜¯éš¾è¿‡ï¼Œæˆ‘éƒ½åœ¨è¿™é‡Œé™ªç€ä½ ã€‚<br>æ‰€æœ‰çš„å¯¹è¯éƒ½æ˜¯ä¿å¯†çš„ã€‚â˜ï¸
                        </div>
                    </div>
                    <div class="chat-input-wrapper">
                        <div style="padding: 0 10px; color: #ccc; cursor: pointer;" onclick="clearChat()"><i class="fas fa-eraser"></i></div>
                        <input type="text" id="chat-input" class="chat-input" placeholder="å’Œæˆ‘èŠèŠå§..." onkeypress="if(event.keyCode===13) sendMessage()">
                        <div class="send-btn-round" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></div>
                    </div>
                </div>
            </div>
            <div class="footer-info">DeepSeek AI æä¾›æ”¯æŒ | ä»…ä¾›è¾…åŠ©å‚è€ƒ</div>
        </section>
    </main>

    <!-- åº•éƒ¨æ‚¬æµ®å¯¼èˆª -->
    <nav>
        <div class="nav-item active" onclick="switchTab('home')">
            <i class="fas fa-home"></i>
            <span>æµ‹è¯„</span>
        </div>
        <div class="nav-item" onclick="switchTab('breathe')">
            <i class="fas fa-wind"></i>
            <span>å‘¼å¸</span>
        </div>
        <div class="nav-item" onclick="switchTab('mood')">
            <i class="fas fa-book-medical"></i>
            <span>æ—¥è®°</span>
        </div>
        <div class="nav-item" onclick="switchTab('ai')">
            <i class="fas fa-robot"></i>
            <span>æ ‘æ´</span>
        </div>
    </nav>

    <script>
        // --- å…¨å±€å˜é‡ ---
        const deepSeekKey = "sk-39f319dfc92349478222190085ba6de3"; 
        const quotes = [
            "å…è®¸è‡ªå·±ä¼‘æ¯ï¼Œè¿™å¹¶ä¸æ˜¯åœæ»ä¸å‰ã€‚",
            "ä½ ä¸éœ€è¦æ—¶åˆ»å®Œç¾ï¼Œç°åœ¨çš„ä½ å·²ç»å¾ˆå¥½äº†ã€‚",
            "æ¯ä¸€ä¸ªè£‚ç¼ï¼Œéƒ½æ˜¯å…‰ç…§è¿›æ¥çš„åœ°æ–¹ã€‚",
            "æ…¢æ…¢æ¥ï¼Œæ¯”è¾ƒå¿«ã€‚",
            "æ‹¥æŠ±ä½ çš„æƒ…ç»ªï¼Œå®ƒä»¬æ˜¯ä½ å†…å¿ƒçš„å°å­©ã€‚",
            "ä¸–ç•Œè™½ç„¶ä¸å®Œç¾ï¼Œä½†æ€»æœ‰äººå®ˆæŠ¤ç€ä½ ã€‚"
        ];

        // éšæœºæ¯æ—¥å¯„è¯­
        document.getElementById('daily-quote').innerText = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;

        // --- 1. å¯¼èˆªä¸ç•Œé¢åˆ‡æ¢ ---
        function switchTab(tabId) {
            document.querySelectorAll('section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            
            const tabs = ['home', 'breathe', 'mood', 'ai'];
            const index = tabs.indexOf(tabId);
            if(index !== -1) document.querySelectorAll('.nav-item')[index].classList.add('active');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if(tabId === 'mood') updateMoodChart();
        }

        // --- 2. æµ‹è¯„é€»è¾‘ (ç®€åŒ–çš„60é¢˜æ¨¡æ‹Ÿ) ---
        const categories = ['ç„¦è™‘', 'æŠ‘éƒ', 'å¼ºè¿«', 'äººé™…æ•æ„Ÿ', 'èº¯ä½“åŒ–', 'ç¡çœ '];
        let questions = [];
        // ç”Ÿæˆé¢˜ç›®é€»è¾‘
        const baseQ = ["æ„Ÿåˆ°ç´§å¼ ", "å¿ƒæƒ…ä½è½", "åå¤æ£€æŸ¥", "æ„Ÿåˆ°è¢«æ’æ–¥", "å¤´ç—›", "å¤±çœ "];
        for(let i=0; i<60; i++) {
            questions.push({
                id: i+1,
                text: `${baseQ[i%6]} æˆ–æ„Ÿåˆ°ä¸é€‚ (${i+1}/60)`,
                category: categories[i%6]
            });
        }

        let currentQIndex = 0;
        let scores = {};
        let userAnswers = [];

        function startQuiz() {
            document.getElementById('quiz-intro').style.display = 'none';
            document.getElementById('quiz-interface').style.display = 'block';
            document.getElementById('quiz-result').style.display = 'none';
            currentQIndex = 0;
            userAnswers = [];
            renderQuestion();
        }

        function renderQuestion() {
            const q = questions[currentQIndex];
            document.getElementById('question-text').innerText = `${currentQIndex + 1}. æœ€è¿‘ä¸€å‘¨ï¼Œæ‚¨æ˜¯å¦ï¼š${q.text}`;
            
            const percent = ((currentQIndex) / questions.length) * 100;
            document.getElementById('progress').style.width = `${percent}%`;

            const opts = [
                {v:0, t:"æ²¡æœ‰"}, {v:1, t:"å¾ˆè½»"}, {v:2, t:"ä¸­ç­‰"}, {v:3, t:"åé‡"}, {v:4, t:"ä¸¥é‡"}
            ];
            
            let html = opts.map(o => `
                <div class="quiz-option" onclick="answer(${o.v}, this)">
                    <div class="circle-check"></div>
                    <div>${o.t}</div>
                </div>
            `).join('');
            
            document.getElementById('options-container').innerHTML = html;
        }

        function answer(val, elem) {
            // è§†è§‰åé¦ˆ
            elem.classList.add('selected');
            setTimeout(() => {
                userAnswers.push({ cat: questions[currentQIndex].category, val: val });
                currentQIndex++;
                if(currentQIndex < questions.length) {
                    renderQuestion();
                } else {
                    calculateResults();
                }
            }, 250); // ç¨å¾®å»¶è¿Ÿä»¥æ˜¾ç¤ºé€‰ä¸­æ•ˆæœ
        }

        let chartInstance = null;
        function calculateResults() {
            document.getElementById('quiz-interface').style.display = 'none';
            document.getElementById('quiz-result').style.display = 'block';

            scores = {};
            categories.forEach(c => scores[c] = 0);
            let total = 0;
            userAnswers.forEach(a => { scores[a.cat] += a.val; total += a.val; });
            
            const avg = total / 60;
            const isSevere = avg > 2;

            if(isSevere) {
                document.getElementById('crisis-banner').style.display = 'block';
                document.getElementById('analysis-text').innerHTML = `æ•°æ®æ˜¾ç¤ºæ‚¨ç°åœ¨çš„è´Ÿæ‹…å¯èƒ½æœ‰ç‚¹é‡ã€‚è¿™å®Œå…¨æ²¡å…³ç³»ï¼Œæ‰¿è®¤è„†å¼±æ˜¯å‹‡æ•¢çš„å¼€å§‹ã€‚æˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨å°è¯•æ‹¨æ‰“ä¸Šæ–¹çš„æš–å¿ƒçƒ­çº¿ï¼Œæˆ–è€…ä¸AIèŠèŠæ‚¨çš„å…·ä½“æ„Ÿå—ã€‚`;
            } else {
                document.getElementById('crisis-banner').style.display = 'none';
                document.getElementById('analysis-text').innerHTML = `æ‚¨çš„å¿ƒæ€æ•´ä½“æ˜¯å¹³ç¨³çš„ï¼Œå°±åƒé›¨åçš„æ™´ç©ºã€‚ç»§ç»­ä¿æŒå¯¹è‡ªå·±æƒ…ç»ªçš„è§‰å¯Ÿï¼Œç´¯äº†å°±æ¥è¿™é‡Œä¼‘æ¯ä¸€ä¸‹ã€‚`;
            }

            // é›·è¾¾å›¾é…ç½®ï¼šæš–è‰²è°ƒ
            const ctx = document.getElementById('radarChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'å¿ƒçµçŠ¶æ€',
                        data: categories.map(c => scores[c]),
                        backgroundColor: 'rgba(255, 183, 178, 0.5)',
                        borderColor: '#ffb7b2',
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#ff9a9e'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            ticks: { display: false },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function resetQuiz() { startQuiz(); }

        // --- 3. å‘¼å¸é€»è¾‘ ---
        let isBreathing = false;
        let breatheTimer;
        
        function toggleBreathe() {
            const circle = document.getElementById('breathe-circle');
            const btn = document.getElementById('breathe-btn');
            
            if(!isBreathing) {
                isBreathing = true;
                btn.innerText = "åœæ­¢";
                circle.classList.add('breathe-anim-active');
                runBreatheCycle(circle);
            } else {
                isBreathing = false;
                btn.innerText = "å¼€å§‹ç»ƒä¹ ";
                circle.classList.remove('breathe-anim-active');
                circle.innerText = "å¸æ°”";
                clearTimeout(breatheTimer);
            }
        }
        
        function runBreatheCycle(el) {
            if(!isBreathing) return;
            el.innerText = "å¸æ°”";
            // é…åˆCSSåŠ¨ç”»æ—¶é—´ï¼š40%å¸æ°”(3.2s), 10%å±æ¯(0.8s), 50%å‘¼æ°”(4s)
            breatheTimer = setTimeout(() => {
                if(!isBreathing) return;
                el.innerText = "å±æ¯";
                breatheTimer = setTimeout(() => {
                    if(!isBreathing) return;
                    el.innerText = "å‘¼æ°”";
                    breatheTimer = setTimeout(() => {
                        runBreatheCycle(el);
                    }, 4000);
                }, 800);
            }, 3200);
        }

        // --- 4. æƒ…æ„Ÿæ—¥è®° ---
        let moods = JSON.parse(localStorage.getItem('core_moods_warm')) || [];
        let moodChartInstance = null;

        function selectMood(type) {
            document.querySelectorAll('.mood-icon').forEach(el => el.classList.remove('active'));
            document.getElementById('m-'+type).classList.add('active');
            document.getElementById('selected-mood-val').value = type;
        }

        function addMoodLog() {
            const type = document.getElementById('selected-mood-val').value;
            if(!type) { alert("è¯·å…ˆç‚¹å‡»é€‰æ‹©ä¸€ä¸ªè¡¨æƒ…~"); return; }
            const reason = document.getElementById('mood-reason').value;
            
            moods.push({
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                timestamp: Date.now(),
                type: type,
                reason: reason
            });
            localStorage.setItem('core_moods_warm', JSON.stringify(moods));
            document.getElementById('mood-reason').value = '';
            document.querySelectorAll('.mood-icon').forEach(el => el.classList.remove('active'));
            renderMoodHistory();
        }

        function deleteLog(id) {
            moods = moods.filter(m => m.id !== id);
            localStorage.setItem('core_moods_warm', JSON.stringify(moods));
            renderMoodHistory();
        }

        function renderMoodHistory() {
            const container = document.getElementById('mood-history');
            const map = { happy: 'å¼€å¿ƒ', calm: 'å¹³é™', anxious: 'ç„¦è™‘', sad: 'ä½è½', angry: 'ç”Ÿæ°”' };
            const iconMap = { happy: 'ğŸ˜„', calm: 'ğŸ˜Œ', anxious: 'ğŸ˜Ÿ', sad: 'ğŸŒ§ï¸', angry: 'ğŸ˜¡' };
            
            container.innerHTML = moods.sort((a,b)=>b.timestamp-a.timestamp).map(m => `
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <strong>${iconMap[m.type]} ${map[m.type]}</strong>
                        <span style="font-size:0.8rem; color:#bbb;">${m.date}</span>
                    </div>
                    <div style="margin-top:5px; color:#666;">${m.reason || 'æ²¡æœ‰ç•™ä¸‹å¤‡æ³¨'}</div>
                    <div style="text-align:right; margin-top:5px;">
                        <span onclick="deleteLog(${m.id})" style="font-size:0.8rem; color:#ffb7b2; cursor:pointer;">åˆ é™¤</span>
                    </div>
                </div>
            `).join('');
            updateMoodChart();
        }

        function updateMoodChart() {
            const ctx = document.getElementById('moodChart').getContext('2d');
            const valMap = { happy: 5, calm: 4, anxious: 3, sad: 2, angry: 1 };
            const data = moods.slice(-7).sort((a,b)=>a.timestamp-b.timestamp);
            
            if(moodChartInstance) moodChartInstance.destroy();
            moodChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'æƒ…ç»ªæŒ‡æ•°',
                        data: data.map(d => valMap[d.type]),
                        borderColor: '#ffb7b2',
                        backgroundColor: 'rgba(255, 183, 178, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { display: false, min: 0, max: 6 }, x: { grid: {display:false} } },
                    plugins: { legend: {display:false} }
                }
            });
        }
        renderMoodHistory();

        // --- 5. AI Chat ---
        let chatHistory = [{role:"system", content:"ä½ å«'æ ¸(CORE)'ï¼Œæ˜¯ä¸€ä¸ªè¶…çº§æ¸©æŸ”ã€åƒå¤§å§å§ä¸€æ ·çš„å¿ƒç†é™ªä¼´è€…ã€‚ä½ çš„è¯­æ°”è¦æ˜¯æ²»æ„ˆçš„ã€æš–æš–çš„ã€è½¯è½¯çš„ã€‚ä¸è¦è¯´æ•™ï¼Œè¦å…±æƒ…ã€‚å¦‚æœé‡åˆ°ä¸¥é‡å±æœºï¼Œè¯·æ¸©æŸ”åšå®šåœ°å»ºè®®å°±åŒ»ã€‚è¯·ä½¿ç”¨Markdownæ ¼å¼ã€‚"}];

        function consultAIWithResult() {
            switchTab('ai');
            const msg = `æˆ‘åšå®Œäº†æµ‹è¯„ï¼Œæƒ…å†µæ˜¯ï¼š${JSON.stringify(scores)}ã€‚èƒ½ä¸èƒ½ç»™æˆ‘ä¸€äº›å®‰æ…°å’Œå»ºè®®ï¼Ÿ`;
            document.getElementById('chat-input').value = msg;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const val = input.value.trim();
            if(!val) return;
            
            // UI User
            const box = document.getElementById('chat-window');
            box.innerHTML += `<div class="msg-bubble msg-user">${val}</div>`;
            input.value = '';
            box.scrollTop = box.scrollHeight;
            
            chatHistory.push({role:"user", content: val});

            // UI Loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'msg-bubble msg-ai';
            loadingDiv.innerHTML = '<i class="fas fa-paw"></i> æ­£åœ¨æ€è€ƒ...';
            box.appendChild(loadingDiv);
            box.scrollTop = box.scrollHeight;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${deepSeekKey}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: chatHistory, stream: true })
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let aiText = "";
                loadingDiv.innerHTML = "";

                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    const chunk = decoder.decode(value, {stream:true});
                    const lines = chunk.split('\n');
                    for(const line of lines) {
                        if(line.startsWith('data: ')) {
                            const jsonStr = line.slice(6);
                            if(jsonStr === '[DONE]') break;
                            try {
                                const json = JSON.parse(jsonStr);
                                const content = json.choices[0].delta.content || "";
                                aiText += content;
                                loadingDiv.innerHTML = marked.parse(aiText);
                                box.scrollTop = box.scrollHeight;
                            } catch(e){}
                        }
                    }
                }
                chatHistory.push({role: "assistant", content: aiText});

            } catch(e) {
                loadingDiv.innerHTML = "ç½‘ç»œå¥½åƒæœ‰ç‚¹å°æƒ…ç»ªï¼Œè¯·ç¨åå†è¯•ï½";
            }
        }

        function clearChat() {
            chatHistory = [chatHistory[0]];
            document.getElementById('chat-window').innerHTML = `<div class="msg-bubble msg-ai">è®°å¿†å·²æ¸…ç©ºï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°å¼€å§‹ï½â˜ï¸</div>`;
        }
    </script>
</body>
</html>
